import{Fragment as Q,computed as C,defineComponent as B,h as q,inject as X,nextTick as F,onMounted as $,onUnmounted as Y,provide as Z,ref as P,toRaw as m,watch as _,watchEffect as U}from"vue";import{Features as K,render as j,omit as J,compact as z}from'../../utils/render.js';import{useId as N}from'../../hooks/use-id.js';import{Keys as V}from'../../keyboard.js';import{calculateActiveIndex as ee,Focus as y}from'../../utils/calculate-active-index.js';import{dom as I}from'../../utils/dom.js';import{useOpenClosed as te,State as W,useOpenClosedProvider as oe}from'../../internal/open-closed.js';import{match as A}from'../../utils/match.js';import{useResolveButtonType as ae}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as le}from'../../utils/focus-management.js';import{useOutsideClick as ie}from'../../hooks/use-outside-click.js';import{Hidden as ue,Features as re}from'../../internal/hidden.js';import{objectToFormEntries as se}from'../../utils/form.js';import{useControllable as de}from'../../hooks/use-controllable.js';import{useTrackedPointer as pe}from'../../hooks/use-tracked-pointer.js';function fe(o,O){return o===O}var be=(s=>(s[s.Open=0]="Open",s[s.Closed=1]="Closed",s))(be||{}),ve=(s=>(s[s.Single=0]="Single",s[s.Multi=1]="Multi",s))(ve||{}),ce=(s=>(s[s.Pointer=0]="Pointer",s[s.Other=1]="Other",s))(ce||{});let G=Symbol("ComboboxContext");function H(o){let O=X(G,null);if(O===null){let s=new Error(`<${o} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(s,H),s}return O}let Be=B({name:"Combobox",emits:{"update:modelValue":o=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>fe},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(o,{slots:O,attrs:s,emit:T}){let e=P(1),t=P(null),d=P(null),g=P(null),p=P(null),b=P({static:!1,hold:!1}),v=P([]),x=P(null),R=P(1),h=P(!1);function w(n=i=>i){let i=x.value!==null?v.value[x.value]:null,r=le(n(v.value.slice()),f=>I(f.dataRef.domRef)),u=i?r.indexOf(i):null;return u===-1&&(u=null),{options:r,activeOptionIndex:u}}let M=C(()=>o.multiple?1:0),c=C(()=>o.nullable),[D,a]=de(C(()=>o.modelValue===void 0?A(M.value,{[1]:[],[0]:void 0}):o.modelValue),n=>T("update:modelValue",n),C(()=>o.defaultValue)),l={comboboxState:e,value:D,mode:M,compare(n,i){if(typeof o.by=="string"){let r=o.by;return(n==null?void 0:n[r])===(i==null?void 0:i[r])}return o.by(n,i)},defaultValue:C(()=>o.defaultValue),nullable:c,inputRef:d,labelRef:t,buttonRef:g,optionsRef:p,disabled:C(()=>o.disabled),options:v,change(n){a(n)},activeOptionIndex:C(()=>{if(h.value&&x.value===null&&v.value.length>0){let n=v.value.findIndex(i=>!i.dataRef.disabled);if(n!==-1)return n}return x.value}),activationTrigger:R,optionsPropsRef:b,closeCombobox(){h.value=!1,!o.disabled&&e.value!==1&&(e.value=1,x.value=null)},openCombobox(){if(h.value=!0,o.disabled||e.value===0)return;let n=v.value.findIndex(i=>{let r=m(i.dataRef.value);return A(M.value,{[0]:()=>l.compare(m(l.value.value),m(r)),[1]:()=>m(l.value.value).some(f=>l.compare(m(f),m(r)))})});n!==-1&&(x.value=n),e.value=0},goToOption(n,i,r){if(h.value=!1,o.disabled||p.value&&!b.value.static&&e.value===1)return;let u=w();if(u.activeOptionIndex===null){let S=u.options.findIndex(L=>!L.dataRef.disabled);S!==-1&&(u.activeOptionIndex=S)}let f=ee(n===y.Specific?{focus:y.Specific,id:i}:{focus:n},{resolveItems:()=>u.options,resolveActiveIndex:()=>u.activeOptionIndex,resolveId:S=>S.id,resolveDisabled:S=>S.dataRef.disabled});x.value=f,R.value=r!=null?r:1,v.value=u.options},selectOption(n){let i=v.value.find(u=>u.id===n);if(!i)return;let{dataRef:r}=i;a(A(M.value,{[0]:()=>r.value,[1]:()=>{let u=m(l.value.value).slice(),f=m(r.value),S=u.findIndex(L=>l.compare(f,m(L)));return S===-1?u.push(f):u.splice(S,1),u}}))},selectActiveOption(){if(l.activeOptionIndex.value===null)return;let{dataRef:n,id:i}=v.value[l.activeOptionIndex.value];a(A(M.value,{[0]:()=>n.value,[1]:()=>{let r=m(l.value.value).slice(),u=m(n.value),f=r.findIndex(S=>l.compare(u,m(S)));return f===-1?r.push(u):r.splice(f,1),r}})),l.goToOption(y.Specific,i)},registerOption(n,i){let r={id:n,dataRef:i},u=w(f=>[...f,r]);if(x.value===null){let f=i.value.value;A(M.value,{[0]:()=>l.compare(m(l.value.value),m(f)),[1]:()=>m(l.value.value).some(L=>l.compare(m(L),m(f)))})&&(u.activeOptionIndex=u.options.indexOf(r))}v.value=u.options,x.value=u.activeOptionIndex,R.value=1},unregisterOption(n){let i=w(r=>{let u=r.findIndex(f=>f.id===n);return u!==-1&&r.splice(u,1),r});v.value=i.options,x.value=i.activeOptionIndex,R.value=1}};ie([d,g,p],()=>l.closeCombobox(),C(()=>e.value===0)),Z(G,l),oe(C(()=>A(e.value,{[0]:W.Open,[1]:W.Closed})));let E=C(()=>l.activeOptionIndex.value===null?null:v.value[l.activeOptionIndex.value].dataRef.value),k=C(()=>{var n;return(n=I(d))==null?void 0:n.closest("form")});return $(()=>{_([k],()=>{if(!k.value||o.defaultValue===void 0)return;function n(){l.change(o.defaultValue)}return k.value.addEventListener("reset",n),()=>{var i;(i=k.value)==null||i.removeEventListener("reset",n)}},{immediate:!0})}),()=>{let{name:n,disabled:i,...r}=o,u={open:e.value===0,disabled:i,activeIndex:l.activeOptionIndex.value,activeOption:E.value,value:D.value};return q(Q,[...n!=null&&D.value!=null?se({[n]:D.value}).map(([f,S])=>q(ue,z({features:re.Hidden,key:f,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:f,value:S}))):[],j({theirProps:{...s,...J(r,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:u,slots:O,attrs:s,name:"Combobox"})])}}}),je=B({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${N()}`}},setup(o,{attrs:O,slots:s}){let T=H("ComboboxLabel");function e(){var t;(t=I(T.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:T.comboboxState.value===0,disabled:T.disabled.value},{id:d,...g}=o,p={id:d,ref:T.labelRef,onClick:e};return j({ourProps:p,theirProps:g,slot:t,attrs:O,slots:s,name:"ComboboxLabel"})}}}),He=B({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${N()}`}},setup(o,{attrs:O,slots:s,expose:T}){let e=H("ComboboxButton");T({el:e.buttonRef,$el:e.buttonRef});function t(p){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(p.preventDefault(),e.openCombobox()),F(()=>{var b;return(b=I(e.inputRef))==null?void 0:b.focus({preventScroll:!0})}))}function d(p){switch(p.key){case V.ArrowDown:p.preventDefault(),p.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),F(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.ArrowUp:p.preventDefault(),p.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),F(()=>{e.value.value||e.goToOption(y.Last)})),F(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.Escape:if(e.comboboxState.value!==0)return;p.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&p.stopPropagation(),e.closeCombobox(),F(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return}}let g=ae(C(()=>({as:o.as,type:O.type})),e.buttonRef);return()=>{var R,h;let p={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:b,...v}=o,x={ref:e.buttonRef,id:b,type:g.value,tabindex:"-1","aria-haspopup":!0,"aria-controls":(R=I(e.optionsRef))==null?void 0:R.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(h=I(e.labelRef))==null?void 0:h.id,b].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:d,onClick:t};return j({ourProps:x,theirProps:v,slot:p,attrs:O,slots:s,name:"ComboboxButton"})}}}),Ne=B({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${N()}`}},emits:{change:o=>!0},setup(o,{emit:O,attrs:s,slots:T,expose:e}){let t=H("ComboboxInput"),d={value:!1};e({el:t.inputRef,$el:t.inputRef});let g=P(t.value.value),p=()=>{var l;let a=t.value.value;return I(t.inputRef)?typeof o.displayValue!="undefined"?(l=o.displayValue(a))!=null?l:"":typeof a=="string"?a:"":""},b=P("");$(()=>{_([t.value,b],()=>{g.value=p()},{flush:"sync",immediate:!0}),_([g,t.comboboxState],([a,l],[E,k])=>{if(d.value)return;let n=I(t.inputRef);!n||(k===0&&l===1||a!==E)&&(n.value=a)},{immediate:!0})});let v=P(!1);function x(){v.value=!0}function R(){setTimeout(()=>{v.value=!1})}function h(a){switch(d.value=!0,a.key){case V.Backspace:case V.Delete:if(t.mode.value!==0||!t.nullable.value)return;let l=a.currentTarget;requestAnimationFrame(()=>{if(l.value===""){t.change(null);let E=I(t.optionsRef);E&&(E.scrollTop=0),t.goToOption(y.Nothing)}});break;case V.Enter:if(d.value=!1,t.comboboxState.value!==0||v.value)return;if(a.preventDefault(),a.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case V.ArrowDown:return d.value=!1,a.preventDefault(),a.stopPropagation(),A(t.comboboxState.value,{[0]:()=>t.goToOption(y.Next),[1]:()=>t.openCombobox()});case V.ArrowUp:return d.value=!1,a.preventDefault(),a.stopPropagation(),A(t.comboboxState.value,{[0]:()=>t.goToOption(y.Previous),[1]:()=>{t.openCombobox(),F(()=>{t.value.value||t.goToOption(y.Last)})}});case V.Home:if(a.shiftKey)break;return d.value=!1,a.preventDefault(),a.stopPropagation(),t.goToOption(y.First);case V.PageUp:return d.value=!1,a.preventDefault(),a.stopPropagation(),t.goToOption(y.First);case V.End:if(a.shiftKey)break;return d.value=!1,a.preventDefault(),a.stopPropagation(),t.goToOption(y.Last);case V.PageDown:return d.value=!1,a.preventDefault(),a.stopPropagation(),t.goToOption(y.Last);case V.Escape:if(d.value=!1,t.comboboxState.value!==0)return;a.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&a.stopPropagation(),t.closeCombobox();break;case V.Tab:if(d.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function w(a){O("change",a)}function M(a){t.openCombobox(),O("change",a)}function c(){d.value=!1}let D=C(()=>{var a,l,E,k;return(k=(E=(l=o.defaultValue)!=null?l:(a=o.displayValue)==null?void 0:a.call(o,t.defaultValue.value))!=null?E:t.defaultValue.value)!=null?k:""});return()=>{var i,r,u,f,S,L;let a={open:t.comboboxState.value===0},{id:l,displayValue:E,...k}=o,n={"aria-controls":(i=t.optionsRef.value)==null?void 0:i.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(r=t.options.value[t.activeOptionIndex.value])==null?void 0:r.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(S=(u=I(t.labelRef))==null?void 0:u.id)!=null?S:(f=I(t.buttonRef))==null?void 0:f.id,id:l,onCompositionstart:x,onCompositionend:R,onKeydown:h,onChange:w,onInput:M,onBlur:c,role:"combobox",type:(L=s.type)!=null?L:"text",tabIndex:0,ref:t.inputRef,defaultValue:D.value};return j({ourProps:n,theirProps:k,slot:a,attrs:s,slots:T,features:K.RenderStrategy|K.Static,name:"ComboboxInput"})}}}),Ke=B({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(o,{attrs:O,slots:s,expose:T}){let e=H("ComboboxOptions"),t=`headlessui-combobox-options-${N()}`;T({el:e.optionsRef,$el:e.optionsRef}),U(()=>{e.optionsPropsRef.value.static=o.static}),U(()=>{e.optionsPropsRef.value.hold=o.hold});let d=te(),g=C(()=>d!==null?d.value===W.Open:e.comboboxState.value===0);return ne({container:C(()=>I(e.optionsRef)),enabled:C(()=>e.comboboxState.value===0),accept(p){return p.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:p.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(p){p.setAttribute("role","none")}}),()=>{var x,R,h,w;let p={open:e.comboboxState.value===0},b={"aria-activedescendant":e.activeOptionIndex.value===null||(x=e.options.value[e.activeOptionIndex.value])==null?void 0:x.id,"aria-labelledby":(w=(R=I(e.labelRef))==null?void 0:R.id)!=null?w:(h=I(e.buttonRef))==null?void 0:h.id,id:t,ref:e.optionsRef,role:"listbox"},v=J(o,["hold"]);return j({ourProps:b,theirProps:v,slot:p,attrs:O,slots:s,features:K.RenderStrategy|K.Static,visible:g.value,name:"ComboboxOptions"})}}}),$e=B({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(o,{slots:O,attrs:s,expose:T}){let e=H("ComboboxOption"),t=`headlessui-combobox-option-${N()}`,d=P(null);T({el:d,$el:d});let g=C(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),p=C(()=>A(e.mode.value,{[0]:()=>e.compare(m(e.value.value),m(o.value)),[1]:()=>m(e.value.value).some(c=>e.compare(m(c),m(o.value)))})),b=C(()=>({disabled:o.disabled,value:o.value,domRef:d}));$(()=>e.registerOption(t,b)),Y(()=>e.unregisterOption(t)),U(()=>{e.comboboxState.value===0&&(!g.value||e.activationTrigger.value!==0&&F(()=>{var c,D;return(D=(c=I(d))==null?void 0:c.scrollIntoView)==null?void 0:D.call(c,{block:"nearest"})}))});function v(c){if(o.disabled)return c.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function x(){if(o.disabled)return e.goToOption(y.Nothing);e.goToOption(y.Specific,t)}let R=pe();function h(c){R.update(c)}function w(c){!R.wasMoved(c)||o.disabled||g.value||e.goToOption(y.Specific,t,0)}function M(c){!R.wasMoved(c)||o.disabled||!g.value||e.optionsPropsRef.value.hold||e.goToOption(y.Nothing)}return()=>{let{disabled:c}=o,D={active:g.value,selected:p.value,disabled:c},a={id:t,ref:d,role:"option",tabIndex:c===!0?void 0:-1,"aria-disabled":c===!0?!0:void 0,"aria-selected":p.value,disabled:void 0,onClick:v,onFocus:x,onPointerenter:h,onMouseenter:h,onPointermove:w,onMousemove:w,onPointerleave:M,onMouseleave:M};return j({ourProps:a,theirProps:o,slot:D,attrs:s,slots:O,name:"ComboboxOption"})}}});export{Be as Combobox,He as ComboboxButton,Ne as ComboboxInput,je as ComboboxLabel,$e as ComboboxOption,Ke as ComboboxOptions};
